{"version":3,"file":"window.js","names":["navigator","raf","caf","pageId: string","env","event: string","callback: (arg: any) => void","taroWindowProvider: TaroWindow"],"sources":["../../src/bom/window.ts"],"sourcesContent":["import { isString } from '@tarojs/shared'\n\nimport { CONTEXT_ACTIONS } from '../constants'\nimport { Events } from '../emitter/emitter'\nimport env from '../env'\nimport { taroGetComputedStyleProvider } from './getComputedStyle'\nimport { History } from './history'\nimport { Location } from './location'\nimport { nav as navigator } from './navigator'\nimport { caf, raf } from './raf'\n\nimport type { TaroHistory } from './history'\nimport type { TaroLocation } from './location'\n\nclass TaroWindow extends Events {\n  navigator = navigator\n  requestAnimationFrame = raf\n  cancelAnimationFrame = caf\n  getComputedStyle = taroGetComputedStyleProvider\n  Date: DateConstructor\n\n  location: TaroLocation\n  history: TaroHistory\n  XMLHttpRequest?: Partial<XMLHttpRequest>\n\n  constructor () {\n    super()\n\n    const globalProperties = [\n      ...Object.getOwnPropertyNames(global || {}),\n      ...Object.getOwnPropertySymbols(global || {})\n    ]\n\n    globalProperties.forEach(property => {\n      if (property === 'atob' || property === 'document') return\n      if (!Object.prototype.hasOwnProperty.call(this, property)) {\n        // 防止小程序环境下，window 上的某些 get 属性在赋值时报错\n        try {\n          this[property] = global[property]\n        } catch (e) {\n          if (process.env.NODE_ENV !== 'production') {\n            console.warn(`[Taro warn] window.${String(property)} 在赋值到 window 时报错`)\n          }\n        }\n      }\n    })\n\n    this.Date ||= Date\n\n    // 应用启动时，提供给需要读取历史信息的库使用\n    this.location = new Location({ window: this }) as any\n    // @ts-ignore\n    this.history = new History(this.location, { window: this })\n\n    this.initEvent()\n  }\n\n  initEvent () {\n    const _location = this.location\n    const _history = this.history\n\n    this.on(CONTEXT_ACTIONS.INIT, (pageId: string) => {\n      // 页面onload，为该页面建立新的上下文信息\n      _location.trigger(CONTEXT_ACTIONS.INIT, pageId)\n    }, null)\n\n    this.on(CONTEXT_ACTIONS.RECOVER, (pageId: string) => {\n      // 页面onshow，恢复当前页面的上下文信息\n      _location.trigger(CONTEXT_ACTIONS.RECOVER, pageId)\n      _history.trigger(CONTEXT_ACTIONS.RECOVER, pageId)\n    }, null)\n\n    this.on(CONTEXT_ACTIONS.RESTORE, (pageId: string) => {\n      // 页面onhide，缓存当前页面的上下文信息\n      _location.trigger(CONTEXT_ACTIONS.RESTORE, pageId)\n      _history.trigger(CONTEXT_ACTIONS.RESTORE, pageId)\n    }, null)\n\n    this.on(CONTEXT_ACTIONS.DESTORY, (pageId: string) => {\n      // 页面onunload，清除当前页面的上下文信息\n      _location.trigger(CONTEXT_ACTIONS.DESTORY, pageId)\n      _history.trigger(CONTEXT_ACTIONS.DESTORY, pageId)\n    }, null)\n  }\n\n  get document () {\n    return env.document\n  }\n\n  addEventListener (event: string, callback: (arg: any) => void) {\n    if (!isString(event)) return\n    this.on(event, callback, null)\n  }\n\n  removeEventListener (event: string, callback: (arg: any) => void) {\n    if (!isString(event)) return\n    this.off(event, callback, null)\n  }\n\n  setTimeout (...args: Parameters<typeof setTimeout>) {\n    return setTimeout(...args)\n  }\n\n  clearTimeout (...args: Parameters<typeof clearTimeout>) {\n    return clearTimeout(...args)\n  }\n}\n\nexport type { TaroWindow }\n\n// Note: 小程序端 vite 打包成 commonjs，const window = xxx 会报错，所以把 window 改为 taroWindowProvider，location 和 history 同理\nexport const taroWindowProvider: TaroWindow = process.env.TARO_PLATFORM === 'web' ? env.window : (env.window = new TaroWindow())\nexport const taroLocationProvider = taroWindowProvider.location\nexport const taroHistoryProvider = taroWindowProvider.history\n"],"mappings":";;;;;;;;;;;AAcA,IAAM,aAAN,cAAyB,OAAO;CAC9B,YAAYA;CACZ,wBAAwBC;CACxB,uBAAuBC;CACvB,mBAAmB;CACnB;CAEA;CACA;CACA;CAEA,cAAe;AACb,SAAO;EAEP,MAAM,mBAAmB,CACvB,GAAG,OAAO,oBAAoB,UAAU,CAAE,EAAC,EAC3C,GAAG,OAAO,sBAAsB,UAAU,CAAE,EAAC,AAC9C;AAED,mBAAiB,QAAQ,cAAY;AACnC,OAAI,aAAa,UAAU,aAAa,WAAY;AACpD,QAAK,OAAO,UAAU,eAAe,KAAK,MAAM,SAAS,CAEvD,KAAI;AACF,SAAK,YAAY,OAAO;GACzB,SAAQ,GAAG;AACV,QAAI,QAAQ,IAAI,aAAa,aAC3B,SAAQ,MAAM,qBAAqB,OAAO,SAAS,CAAC,kBAAkB;GAEzE;EAEJ,EAAC;AAEF,OAAK,SAAS;AAGd,OAAK,WAAW,IAAI,SAAS,EAAE,QAAQ,KAAM;AAE7C,OAAK,UAAU,IAAI,QAAQ,KAAK,UAAU,EAAE,QAAQ,KAAM;AAE1D,OAAK,WAAW;CACjB;CAED,YAAa;EACX,MAAM,YAAY,KAAK;EACvB,MAAM,WAAW,KAAK;AAEtB,OAAK,GAAG,gBAAgB,MAAM,CAACC,WAAmB;AAEhD,aAAU,QAAQ,gBAAgB,MAAM,OAAO;EAChD,GAAE,KAAK;AAER,OAAK,GAAG,gBAAgB,SAAS,CAACA,WAAmB;AAEnD,aAAU,QAAQ,gBAAgB,SAAS,OAAO;AAClD,YAAS,QAAQ,gBAAgB,SAAS,OAAO;EAClD,GAAE,KAAK;AAER,OAAK,GAAG,gBAAgB,SAAS,CAACA,WAAmB;AAEnD,aAAU,QAAQ,gBAAgB,SAAS,OAAO;AAClD,YAAS,QAAQ,gBAAgB,SAAS,OAAO;EAClD,GAAE,KAAK;AAER,OAAK,GAAG,gBAAgB,SAAS,CAACA,WAAmB;AAEnD,aAAU,QAAQ,gBAAgB,SAAS,OAAO;AAClD,YAAS,QAAQ,gBAAgB,SAAS,OAAO;EAClD,GAAE,KAAK;CACT;CAED,IAAI,WAAY;AACd,SAAOC,YAAI;CACZ;CAED,iBAAkBC,OAAeC,UAA8B;AAC7D,OAAK,SAAS,MAAM,CAAE;AACtB,OAAK,GAAG,OAAO,UAAU,KAAK;CAC/B;CAED,oBAAqBD,OAAeC,UAA8B;AAChE,OAAK,SAAS,MAAM,CAAE;AACtB,OAAK,IAAI,OAAO,UAAU,KAAK;CAChC;CAED,WAAY,GAAG,MAAqC;AAClD,SAAO,WAAW,GAAG,KAAK;CAC3B;CAED,aAAc,GAAG,MAAuC;AACtD,SAAO,aAAa,GAAG,KAAK;CAC7B;AACF;AAKD,MAAaC,qBAAiC,QAAQ,IAAI,kBAAkB,QAAQH,YAAI,SAAUA,YAAI,SAAS,IAAI;AACnH,MAAa,uBAAuB,mBAAmB;AACvD,MAAa,sBAAsB,mBAAmB"}