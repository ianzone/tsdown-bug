{"version":3,"file":"history.js","names":["Events","location: TaroLocation","options: Options","#window","#location","href: string","#cur","#stack","#reset","pageId: string","delta: number","state: any","title: string","url: string","History: typeof TaroHistory","env"],"sources":["../../src/bom/history.ts"],"sourcesContent":["import { isNumber, isString } from '@tarojs/shared'\n\nimport { CONTEXT_ACTIONS } from '../constants'\nimport { Events } from '../emitter/emitter'\nimport env from '../env'\nimport { RuntimeCache } from '../utils/cache'\n\nimport type { TaroLocation } from './location'\n\nexport interface HistoryState {\n  state: Record<string, any> | null\n  title: string\n  url: string\n}\n\ntype Options = {\n  window: any\n}\ntype HistoryContext = {\n  location: TaroLocation\n  stack: HistoryState[]\n  cur: number\n}\nconst cache = new RuntimeCache<HistoryContext>('history')\n\nclass TaroHistory extends Events {\n  /* private property */\n  #location: TaroLocation\n  #stack: HistoryState[] = []\n  #cur = 0\n\n  #window: any\n\n  constructor (location: TaroLocation, options: Options) {\n    super()\n\n    this.#window = options.window\n    this.#location = location\n\n    this.#location.on('__record_history__', (href: string) => {\n      this.#cur++\n      this.#stack = this.#stack.slice(0, this.#cur)\n      this.#stack.push({\n        state: null,\n        title: '',\n        url: href\n      })\n    }, null)\n\n    this.#location.on('__reset_history__', (href: string) => {\n      this.#reset(href)\n    }, null)\n\n    // 切换上下文行为\n\n    this.on(CONTEXT_ACTIONS.INIT, () => {\n      this.#reset()\n    }, null)\n\n    this.on(CONTEXT_ACTIONS.RESTORE, (pageId: string) => {\n      cache.set(pageId, {\n        location: this.#location,\n        stack: this.#stack.slice(),\n        cur: this.#cur\n      })\n    }, null)\n\n    this.on(CONTEXT_ACTIONS.RECOVER, (pageId: string) => {\n      if (cache.has(pageId)) {\n        const ctx = cache.get(pageId)!\n        this.#location = ctx.location\n        this.#stack = ctx.stack\n        this.#cur = ctx.cur\n      }\n    }, null)\n\n    this.on(CONTEXT_ACTIONS.DESTORY, (pageId: string) => {\n      cache.delete(pageId)\n    }, null)\n\n    this.#reset()\n  }\n\n  #reset (href = '') {\n    this.#stack = [\n      {\n        state: null,\n        title: '',\n        url: href || this.#location.href\n      }\n    ]\n    this.#cur = 0\n  }\n\n  /* public property */\n  get length () {\n    return this.#stack.length\n  }\n\n  get state () {\n    return this.#stack[this.#cur].state\n  }\n\n  /* public method */\n  go (delta: number) {\n    if (!isNumber(delta) || isNaN(delta)) return\n\n    let targetIdx = this.#cur + delta\n    targetIdx = Math.min(Math.max(targetIdx, 0), this.length - 1)\n\n    this.#cur = targetIdx\n\n    this.#location.trigger('__set_href_without_history__', this.#stack[this.#cur].url)\n    this.#window.trigger('popstate', this.#stack[this.#cur])\n  }\n\n  back () {\n    this.go(-1)\n  }\n\n  forward () {\n    this.go(1)\n  }\n\n  pushState (state: any, title: string, url: string) {\n    if (!url || !isString(url)) return\n    this.#stack = this.#stack.slice(0, this.#cur + 1)\n    this.#stack.push({\n      state,\n      title,\n      url\n    })\n    this.#cur = this.length - 1\n\n    this.#location.trigger('__set_href_without_history__', url)\n  }\n\n  replaceState (state: any, title: string, url: string) {\n    if (!url || !isString(url)) return\n    this.#stack[this.#cur] = {\n      state,\n      title,\n      url\n    }\n\n    this.#location.trigger('__set_href_without_history__', url)\n  }\n\n  // For debug\n  get cache () {\n    return cache\n  }\n}\n\nexport type { TaroHistory }\nexport const History: typeof TaroHistory = process.env.TARO_PLATFORM === 'web' ? env.window.History : TaroHistory\n"],"mappings":";;;;;;;;;AAuBA,MAAM,QAAQ,IAAI,aAA6B;AAE/C,IAAM,cAAN,cAA0BA,wBAAO;CAE/B;CACA,SAAyB,CAAE;CAC3B,OAAO;CAEP;CAEA,YAAaC,UAAwBC,SAAkB;AACrD,SAAO;AAEP,OAAKC,UAAU,QAAQ;AACvB,OAAKC,YAAY;AAEjB,OAAKA,UAAU,GAAG,sBAAsB,CAACC,SAAiB;AACxD,QAAKC;AACL,QAAKC,SAAS,KAAKA,OAAO,MAAM,GAAG,KAAKD,KAAK;AAC7C,QAAKC,OAAO,KAAK;IACf,OAAO;IACP,OAAO;IACP,KAAK;GACN,EAAC;EACH,GAAE,KAAK;AAER,OAAKH,UAAU,GAAG,qBAAqB,CAACC,SAAiB;AACvD,QAAKG,OAAO,KAAK;EAClB,GAAE,KAAK;AAIR,OAAK,GAAG,gBAAgB,MAAM,MAAM;AAClC,QAAKA,QAAQ;EACd,GAAE,KAAK;AAER,OAAK,GAAG,gBAAgB,SAAS,CAACC,WAAmB;AACnD,SAAM,IAAI,QAAQ;IAChB,UAAU,KAAKL;IACf,OAAO,KAAKG,OAAO,OAAO;IAC1B,KAAK,KAAKD;GACX,EAAC;EACH,GAAE,KAAK;AAER,OAAK,GAAG,gBAAgB,SAAS,CAACG,WAAmB;AACnD,OAAI,MAAM,IAAI,OAAO,EAAE;IACrB,MAAM,MAAM,MAAM,IAAI,OAAO;AAC7B,SAAKL,YAAY,IAAI;AACrB,SAAKG,SAAS,IAAI;AAClB,SAAKD,OAAO,IAAI;GACjB;EACF,GAAE,KAAK;AAER,OAAK,GAAG,gBAAgB,SAAS,CAACG,WAAmB;AACnD,SAAM,OAAO,OAAO;EACrB,GAAE,KAAK;AAER,OAAKD,QAAQ;CACd;CAED,OAAQ,OAAO,IAAI;AACjB,OAAKD,SAAS,CACZ;GACE,OAAO;GACP,OAAO;GACP,KAAK,QAAQ,KAAKH,UAAU;EAC7B,CACF;AACD,OAAKE,OAAO;CACb;CAGD,IAAI,SAAU;AACZ,SAAO,KAAKC,OAAO;CACpB;CAED,IAAI,QAAS;AACX,SAAO,KAAKA,OAAO,KAAKD,MAAM;CAC/B;CAGD,GAAII,OAAe;AACjB,OAAK,iCAAS,MAAM,IAAI,MAAM,MAAM,CAAE;EAEtC,IAAI,YAAY,KAAKJ,OAAO;AAC5B,cAAY,KAAK,IAAI,KAAK,IAAI,WAAW,EAAE,EAAE,KAAK,SAAS,EAAE;AAE7D,OAAKA,OAAO;AAEZ,OAAKF,UAAU,QAAQ,gCAAgC,KAAKG,OAAO,KAAKD,MAAM,IAAI;AAClF,OAAKH,QAAQ,QAAQ,YAAY,KAAKI,OAAO,KAAKD,MAAM;CACzD;CAED,OAAQ;AACN,OAAK,IAAI,EAAE;CACZ;CAED,UAAW;AACT,OAAK,GAAG,EAAE;CACX;CAED,UAAWK,OAAYC,OAAeC,KAAa;AACjD,OAAK,QAAQ,iCAAS,IAAI,CAAE;AAC5B,OAAKN,SAAS,KAAKA,OAAO,MAAM,GAAG,KAAKD,OAAO,EAAE;AACjD,OAAKC,OAAO,KAAK;GACf;GACA;GACA;EACD,EAAC;AACF,OAAKD,OAAO,KAAK,SAAS;AAE1B,OAAKF,UAAU,QAAQ,gCAAgC,IAAI;CAC5D;CAED,aAAcO,OAAYC,OAAeC,KAAa;AACpD,OAAK,QAAQ,iCAAS,IAAI,CAAE;AAC5B,OAAKN,OAAO,KAAKD,QAAQ;GACvB;GACA;GACA;EACD;AAED,OAAKF,UAAU,QAAQ,gCAAgC,IAAI;CAC5D;CAGD,IAAI,QAAS;AACX,SAAO;CACR;AACF;AAGD,MAAaU,UAA8B,QAAQ,IAAI,kBAAkB,QAAQC,YAAI,OAAO,UAAU"}