{"version":3,"file":"style.js","names":["obj: Style","newVal: string","styleKey: string","ctor: typeof Style","styleProperties: string[]","styleProperties","element: TaroElement","texts: string[]","str: string","propertyName: string","value?: string | null","newStyleProperties: string[]"],"sources":["../../src/dom/style.ts"],"sourcesContent":["import { hooks, isArray, isNull, isString, isUndefined, Shortcuts, toCamelCase, toDashed, warn } from '@tarojs/shared'\n\nimport { PROPERTY_THRESHOLD } from '../constants'\nimport { MutationObserver, MutationRecordType } from '../dom-external/mutation-observer'\nimport { TaroElement } from './element'\nimport { styleProperties } from './style_properties'\n\nfunction recordCss (obj: Style) {\n  MutationObserver.record({\n    type: MutationRecordType.ATTRIBUTES,\n    target: obj._element,\n    attributeName: 'style',\n    oldValue: obj.cssText\n  })\n}\n\nfunction enqueueUpdate (obj: Style) {\n  const element = obj._element\n  if (element._root) {\n    element.enqueueUpdate({\n      path: `${element._path}.${Shortcuts.Style}`,\n      value: obj.cssText\n    })\n  }\n}\n\nfunction setStyle (this: Style, newVal: string, styleKey: string) {\n  process.env.NODE_ENV !== 'production' && warn(\n    isString(newVal) && newVal.length > PROPERTY_THRESHOLD,\n    `Style 属性 ${styleKey} 的值数据量过大，可能会影响渲染性能，考虑使用 CSS 类或其它方案替代。`\n  )\n\n  const old = this[styleKey]\n\n  if (old === newVal) return\n\n  !this._pending && recordCss(this)\n\n  if (isNull(newVal) || isUndefined(newVal) || newVal === '') {\n    this._usedStyleProp.delete(styleKey)\n    delete this._value[styleKey]\n  } else {\n    this._usedStyleProp.add(styleKey)\n    this._value[styleKey] = newVal\n  }\n\n  !this._pending && enqueueUpdate(this)\n}\n\nfunction initStyle (ctor: typeof Style, styleProperties: string[]) {\n  const properties = {}\n\n  for (let i = 0; i < styleProperties.length; i++) {\n    const styleKey = styleProperties[i]\n\n    if (ctor[styleKey]) return\n\n    properties[styleKey] = {\n      get (this: Style) {\n        const val = this._value[styleKey]\n        return isNull(val) || isUndefined(val) ? '' : val\n      },\n      set (this: Style, newVal: string) {\n        setStyle.call(this, newVal, styleKey)\n      }\n    }\n  }\n\n  Object.defineProperties(ctor.prototype, properties)\n}\n\nfunction isCssVariable (propertyName) {\n  return /^--/.test(propertyName)\n}\n\nexport class Style {\n  public _pending: boolean\n\n  public _usedStyleProp: Set<string>\n\n  public _value: Partial<CSSStyleDeclaration>\n\n  public _element: TaroElement\n\n  public constructor (element: TaroElement) {\n    this._element = element\n    this._usedStyleProp = new Set()\n    this._value = {}\n  }\n\n  private setCssVariables (styleKey: string) {\n    this.hasOwnProperty(styleKey) || Object.defineProperty(this, styleKey, {\n      enumerable: true,\n      configurable: true,\n      get: () => {\n        return this._value[styleKey] || ''\n      },\n      set: (newVal: string) => {\n        setStyle.call(this, newVal, styleKey)\n      }\n    })\n  }\n\n  public get cssText () {\n    if (!this._usedStyleProp.size) return ''\n\n    const texts: string[] = []\n    this._usedStyleProp.forEach(key => {\n      const val = this[key]\n      if (isNull(val) || isUndefined(val)) return\n      let styleName = isCssVariable(key) ? key : toDashed(key)\n      if (styleName.indexOf('webkit') === 0 || styleName.indexOf('Webkit') === 0) {\n        styleName = `-${styleName}`\n      }\n      texts.push(`${styleName}: ${val};`)\n    })\n    return texts.join(' ')\n  }\n\n  public set cssText (str: string) {\n    this._pending = true\n    recordCss(this)\n\n    this._usedStyleProp.forEach(prop => {\n      this.removeProperty(prop)\n    })\n\n    if (str === '' || isUndefined(str) || isNull(str)) {\n      this._pending = false\n      enqueueUpdate(this)\n      return\n    }\n\n    const rules = str.split(';')\n\n    for (let i = 0; i < rules.length; i++) {\n      const rule = rules[i].trim()\n      if (rule === '') {\n        continue\n      }\n\n      // 可能存在 'background: url(http:x/y/z)' 的情况\n      const [propName, ...valList] = rule.split(':')\n      const val = valList.join(':')\n\n      if (isUndefined(val)) {\n        continue\n      }\n      this.setProperty(propName.trim(), val.trim())\n    }\n\n    this._pending = false\n    enqueueUpdate(this)\n  }\n\n  public setProperty (propertyName: string, value?: string | null) {\n    if (propertyName[0] === '-') {\n      // 支持 webkit 属性或 css 变量\n      this.setCssVariables(propertyName)\n    } else {\n      propertyName = toCamelCase(propertyName)\n    }\n\n    if (isNull(value) || isUndefined(value)) {\n      this.removeProperty(propertyName)\n    } else {\n      this[propertyName] = value\n    }\n  }\n\n  public removeProperty (propertyName: string): string {\n    propertyName = toCamelCase(propertyName)\n    if (!this._usedStyleProp.has(propertyName)) {\n      return ''\n    }\n\n    const value = this[propertyName]\n    this[propertyName] = undefined\n    return value\n  }\n\n  public getPropertyValue (propertyName: string) {\n    propertyName = toCamelCase(propertyName)\n    const value = this[propertyName]\n    if (!value) {\n      return ''\n    }\n\n    return value\n  }\n}\n\ninitStyle(Style, styleProperties)\n\nhooks.tap('injectNewStyleProperties', (newStyleProperties: string[]) => {\n  if (isArray(newStyleProperties)) {\n    initStyle(Style, newStyleProperties)\n  } else {\n    if (typeof newStyleProperties !== 'string') return\n\n    initStyle(Style, [newStyleProperties])\n  }\n})\n"],"mappings":"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"}