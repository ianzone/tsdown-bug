{"version":3,"file":"event.js","names":["type: string","opts: EventOptions","event?: MpEvent","env","event: MpEvent | string","node?: TaroElement","event: MpEvent"],"sources":["../../src/dom/event.ts"],"sourcesContent":["import { EMPTY_OBJ, hooks, isUndefined } from '@tarojs/shared'\n\nimport {\n  CONFIRM,\n  CURRENT_TARGET,\n  EVENT_CALLBACK_RESULT,\n  INPUT,\n  KEY_CODE,\n  TARGET,\n  TIME_STAMP,\n  TOUCHMOVE,\n  TYPE\n} from '../constants'\nimport env from '../env'\nimport { isParentBinded } from '../utils'\n\nimport type { EventOptions, MpEvent } from '../interface'\nimport type { TaroElement } from './element'\n\n// Taro 事件对象。以 Web 标准的事件对象为基础，加入小程序事件对象中携带的部分信息，并模拟实现事件冒泡。\nexport class TaroEvent {\n  private cacheTarget\n  private cacheCurrentTarget\n\n  public type: string\n\n  public bubbles: boolean\n\n  public cancelable: boolean\n\n  public _stop = false\n\n  public _end = false\n\n  public defaultPrevented = false\n\n  // Mouse Event botton property, it's used in 3rd lib, like react-router. default 0 in general\n  public button = 0\n\n  // timestamp can either be hi-res ( relative to page load) or low-res (relative to UNIX epoch)\n  // here use hi-res timestamp\n  public timeStamp = Date.now()\n\n  public mpEvent: MpEvent | undefined\n\n  public constructor (type: string, opts: EventOptions, event?: MpEvent) {\n    this.type = type.toLowerCase()\n    this.mpEvent = event\n    this.bubbles = Boolean(opts && opts.bubbles)\n    this.cancelable = Boolean(opts && opts.cancelable)\n  }\n\n  public stopPropagation () {\n    this._stop = true\n  }\n\n  public stopImmediatePropagation () {\n    this._end = this._stop = true\n  }\n\n  public preventDefault () {\n    this.defaultPrevented = true\n  }\n\n  get target () {\n    const cacheTarget = this.cacheTarget\n    if (!cacheTarget) {\n      const target = Object.create(this.mpEvent?.target || null)\n      const currentEle = env.document.getElementById(target.dataset?.sid || target.id || null)\n      // Note：优先判断冒泡场景alipay的targetDataset的sid, 不然冒泡场景target属性吐出不对，其余拿取当前绑定id\n      const element = env.document.getElementById(target.targetDataset?.sid || target.dataset?.sid || target.id || null)\n\n      target.dataset = {\n        ...(currentEle !== null ? currentEle.dataset : EMPTY_OBJ),\n        ...(element !== null ? element.dataset : EMPTY_OBJ)\n      }\n\n      for (const key in this.mpEvent?.detail) {\n        target[key] = this.mpEvent!.detail[key]\n      }\n\n      this.cacheTarget = target\n\n      return target\n    } else {\n      return cacheTarget\n    }\n  }\n\n  get currentTarget () {\n    const cacheCurrentTarget = this.cacheCurrentTarget\n    if (!cacheCurrentTarget) {\n      const doc = env.document\n\n      const currentTarget = Object.create(this.mpEvent?.currentTarget || null)\n\n      const element = doc.getElementById(currentTarget.dataset?.sid || currentTarget.id || null)\n      const targetElement = doc.getElementById(this.mpEvent?.target?.dataset?.sid as string || this.mpEvent?.target?.id as string || null)\n\n      if (element === null || (element && element === targetElement)) {\n        this.cacheCurrentTarget = this.target\n        return this.target\n      }\n\n      currentTarget.dataset = element.dataset\n\n      for (const key in this.mpEvent?.detail) {\n        currentTarget[key] = this.mpEvent!.detail[key]\n      }\n\n      this.cacheCurrentTarget = currentTarget\n\n      return currentTarget\n    } else {\n      return cacheCurrentTarget\n    }\n  }\n}\n\nexport function createEvent (event: MpEvent | string, node?: TaroElement) {\n  if (typeof event === 'string') {\n    // For Vue3 using document.createEvent\n    return new TaroEvent(event, { bubbles: true, cancelable: true })\n  }\n\n  const domEv = new TaroEvent(event.type, { bubbles: true, cancelable: true }, event)\n\n  for (const key in event) {\n    if (key === CURRENT_TARGET || key === TARGET || key === TYPE || key === TIME_STAMP) {\n      continue\n    } else {\n      domEv[key] = event[key]\n    }\n  }\n\n  if (domEv.type === CONFIRM && node?.nodeName === INPUT) {\n    // eslint-disable-next-line dot-notation\n    domEv[KEY_CODE] = 13\n  }\n\n  return domEv\n}\n\nconst eventsBatch = {}\n\nfunction getEventCBResult (event: MpEvent) {\n  const result = event[EVENT_CALLBACK_RESULT]\n  if (!isUndefined(result)) {\n    delete event[EVENT_CALLBACK_RESULT]\n  }\n  return result\n}\n\n// 小程序的事件代理回调函数\nexport function eventHandler (event: MpEvent) {\n  // Note: ohos 上事件没有设置 type、detail 类型 setter 方法，且部分事件（例如 load 等）缺失 target 导致事件错误\n  event.type === undefined && Object.defineProperty(event, 'type', {\n    value: (event as any)._type // ohos only\n  })\n  event.detail === undefined && Object.defineProperty(event, 'detail', {\n    value: (event as any)._detail || { ...event } // ohos only\n  })\n  event.currentTarget = event.currentTarget || event.target || { ...event }\n  hooks.call('modifyMpEventImpl', event)\n\n  const currentTarget = event.currentTarget\n  const id = currentTarget.dataset?.sid as string /** sid */ || currentTarget.id /** uid */ || event.detail?.id as string || ''\n\n  const node = env.document.getElementById(id)\n  if (node) {\n    const dispatch = () => {\n      const e = createEvent(event, node)\n\n      hooks.call('modifyTaroEvent', e, node)\n      hooks.call('dispatchTaroEvent', e, node)\n      hooks.call('dispatchTaroEventFinish', e, node)\n    }\n    if (hooks.isExist('batchedEventUpdates')) {\n      const type = event.type\n\n      if (\n        !hooks.call('isBubbleEvents', type) ||\n        !isParentBinded(node, type) ||\n        (type === TOUCHMOVE && !!node.props.catchMove)\n      ) {\n        // 最上层组件统一 batchUpdate\n        hooks.call('batchedEventUpdates', () => {\n          if (eventsBatch[type]) {\n            eventsBatch[type].forEach(fn => fn())\n            delete eventsBatch[type]\n          }\n          dispatch()\n        })\n        return getEventCBResult(event)\n      } else {\n        // 如果上层组件也有绑定同类型的组件，委托给上层组件调用事件回调\n        (eventsBatch[type] ||= []).push(dispatch)\n      }\n    } else {\n      dispatch()\n      return getEventCBResult(event)\n    }\n  }\n}\n"],"mappings":"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"}