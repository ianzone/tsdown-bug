{"version":3,"file":"event-target.js","names":["type: string","handler: EventHandler","options?: boolean | AddEventListenerOptions"],"sources":["../../src/dom/event-target.ts"],"sourcesContent":["import { hooks, isArray, isObject, warn } from '@tarojs/shared'\n\nimport type { AddEventListenerOptions, EventHandler } from '../interface'\n\nexport class TaroEventTarget {\n  public __handlers: Record<string, EventHandler[]> = {}\n\n  public addEventListener (type: string, handler: EventHandler, options?: boolean | AddEventListenerOptions) {\n    type = type.toLowerCase()\n\n    hooks.call('onAddEvent', type, handler, options, this)\n\n    if (type === 'regionchange') {\n      // map 组件的 regionchange 事件非常特殊，详情：https://github.com/NervJS/taro/issues/5766\n      this.addEventListener('begin', handler, options)\n      this.addEventListener('end', handler, options)\n      return\n    }\n\n    let isCapture = Boolean(options)\n    let isOnce = false\n    if (isObject<AddEventListenerOptions>(options)) {\n      isCapture = Boolean(options.capture)\n      isOnce = Boolean(options.once)\n    }\n\n    if (isOnce) {\n      const wrapper = function () {\n        handler.apply(this, arguments) // this 指向 Element\n        this.removeEventListener(type, wrapper)\n      }\n      this.addEventListener(type, wrapper, {\n        ...(options as AddEventListenerOptions),\n        once: false\n      })\n      return\n    }\n\n    process.env.NODE_ENV !== 'production' && warn(isCapture, 'Taro 暂未实现 event 的 capture 特性。')\n\n    // 某些框架，如 PReact 有委托的机制，handler 始终是同一个函数\n    // 这会导致多层停止冒泡失败：view -> view(handler.stop = false) -> view(handler.stop = true)\n    // 这样解决：view -> view(handlerA.stop = false) -> view(handlerB.stop = false)\n    // 因此每次绑定事件都新建一个函数，如果带来了性能问题，可以把这段逻辑抽取到 PReact 插件中。\n    const oldHandler = handler\n    handler = function () {\n      return oldHandler.apply(this, arguments) // this 指向 Element\n    }\n    ;(handler as any).oldHandler = oldHandler\n\n    const handlers = this.__handlers[type]\n    if (isArray(handlers)) {\n      handlers.push(handler)\n    } else {\n      this.__handlers[type] = [handler]\n    }\n  }\n\n  public removeEventListener (type: string, handler: EventHandler) {\n    type = type.toLowerCase()\n\n    if (type === 'regionchange') {\n      // map 组件的 regionchange 事件非常特殊，详情：https://github.com/NervJS/taro/issues/5766\n      this.removeEventListener('begin', handler)\n      this.removeEventListener('end', handler)\n      return\n    }\n\n    if (!handler) {\n      return\n    }\n\n    const handlers = this.__handlers[type]\n    if (!isArray(handlers)) {\n      return\n    }\n\n    const index = handlers.findIndex(item => {\n      if (item === handler || (item as any).oldHandler === handler) return true\n    })\n\n    process.env.NODE_ENV !== 'production' && warn(index === -1, `事件: '${type}' 没有注册在 DOM 中，因此不会被移除。`)\n\n    handlers.splice(index, 1)\n  }\n\n  public isAnyEventBinded (): boolean {\n    const handlers = this.__handlers\n    const isAnyEventBinded = Object.keys(handlers).find(key => handlers[key].length)\n    return Boolean(isAnyEventBinded)\n  }\n\n  public isOnlyClickBinded (): boolean {\n    const handlers = this.__handlers\n    const isOnlyClickBinded = handlers.tap && Object.keys(handlers).length === 1\n    return Boolean(isOnlyClickBinded)\n  }\n}\n"],"mappings":";;;AAIA,IAAa,kBAAb,MAA6B;CAC3B,AAAO,aAA6C,CAAE;CAEtD,AAAO,iBAAkBA,MAAcC,SAAuBC,SAA6C;AACzG,SAAO,KAAK,aAAa;AAEzB,QAAM,KAAK,cAAc,MAAM,SAAS,SAAS,KAAK;AAEtD,MAAI,SAAS,gBAAgB;AAE3B,QAAK,iBAAiB,SAAS,SAAS,QAAQ;AAChD,QAAK,iBAAiB,OAAO,SAAS,QAAQ;AAC9C;EACD;EAED,IAAI,YAAY,QAAQ,QAAQ;EAChC,IAAI,SAAS;AACb,MAAI,SAAkC,QAAQ,EAAE;AAC9C,eAAY,QAAQ,QAAQ,QAAQ;AACpC,YAAS,QAAQ,QAAQ,KAAK;EAC/B;AAED,MAAI,QAAQ;GACV,MAAM,UAAU,WAAY;AAC1B,YAAQ,MAAM,MAAM,UAAU;AAC9B,SAAK,oBAAoB,MAAM,QAAQ;GACxC;AACD,QAAK,iBAAiB,MAAM,SAAS;IACnC,GAAI;IACJ,MAAM;GACP,EAAC;AACF;EACD;AAED,UAAQ,IAAI,aAAa,gBAAgB,KAAK,WAAW,gCAAgC;EAMzF,MAAM,aAAa;AACnB,YAAU,WAAY;AACpB,UAAO,WAAW,MAAM,MAAM,UAAU;EACzC;AACA,EAAC,QAAgB,aAAa;EAE/B,MAAM,WAAW,KAAK,WAAW;AACjC,MAAI,QAAQ,SAAS,EAAE;AACrB,YAAS,KAAK,QAAQ;EACvB,OAAM;AACL,QAAK,WAAW,QAAQ,CAAC,OAAQ;EAClC;CACF;CAED,AAAO,oBAAqBF,MAAcC,SAAuB;AAC/D,SAAO,KAAK,aAAa;AAEzB,MAAI,SAAS,gBAAgB;AAE3B,QAAK,oBAAoB,SAAS,QAAQ;AAC1C,QAAK,oBAAoB,OAAO,QAAQ;AACxC;EACD;AAED,OAAK,SAAS;AACZ;EACD;EAED,MAAM,WAAW,KAAK,WAAW;AACjC,OAAK,QAAQ,SAAS,EAAE;AACtB;EACD;EAED,MAAM,QAAQ,SAAS,UAAU,UAAQ;AACvC,OAAI,SAAS,WAAY,KAAa,eAAe,QAAS,QAAO;EACtE,EAAC;AAEF,UAAQ,IAAI,aAAa,gBAAgB,KAAK,WAAW,IAAI,OAAO,KAAK,wBAAwB;AAEjG,WAAS,OAAO,OAAO,EAAE;CAC1B;CAED,AAAO,mBAA6B;EAClC,MAAM,WAAW,KAAK;EACtB,MAAM,mBAAmB,OAAO,KAAK,SAAS,CAAC,KAAK,SAAO,SAAS,KAAK,OAAO;AAChF,SAAO,QAAQ,iBAAiB;CACjC;CAED,AAAO,oBAA8B;EACnC,MAAM,WAAW,KAAK;EACtB,MAAM,oBAAoB,SAAS,OAAO,OAAO,KAAK,SAAS,CAAC,WAAW;AAC3E,SAAO,QAAQ,kBAAkB;CAClC;AACF"}