{"version":3,"file":"hydrate.js","names":["node: TaroElement | TaroText","Shortcuts","data: MiniElementData","node"],"sources":["../src/hydrate.ts"],"sourcesContent":["import { hooks, Shortcuts, toCamelCase } from '@tarojs/shared'\n\nimport {\n  CATCH_VIEW,\n  CATCHMOVE,\n  CLASS,\n  CLICK_VIEW,\n  COMPILE_MODE,\n  ID,\n  PURE_VIEW,\n  STYLE,\n  VIEW\n} from './constants'\nimport { getComponentsAlias, isComment, isHasExtractProp, isText } from './utils'\n\nimport type { TaroElement } from './dom/element'\nimport type { TaroText } from './dom/text'\nimport type { MiniData, MiniElementData } from './interface'\n\nlet SPECIAL_NODES\nlet componentsAlias\n\n/**\n * React also has a fancy function's name for this: `hydrate()`.\n * You may have been heard `hydrate` as a SSR-related function,\n * actually, `hydrate` basicly do the `render()` thing, but ignore some properties,\n * it's a vnode traverser and modifier: that's exactly what Taro's doing in here.\n */\nexport function hydrate (node: TaroElement | TaroText): MiniData {\n  // 初始化 componentsAlias\n  componentsAlias ||= getComponentsAlias()\n\n  // 初始化 SPECIAL_NODES\n  SPECIAL_NODES ||= hooks.call('getSpecialNodes')!\n\n  const nodeName = node.nodeName\n  let compileModeName = null\n\n  if (isText(node)) {\n    return {\n      sid: node.sid,\n      [Shortcuts.Text]: node.nodeValue,\n      [Shortcuts.NodeName]: componentsAlias[nodeName]?._num || '8'\n    }\n  }\n\n  const data: MiniElementData = {\n    [Shortcuts.NodeName]: nodeName,\n    sid: node.sid\n  }\n\n  if (node.uid !== node.sid) {\n    data.uid = node.uid\n  }\n\n  if (SPECIAL_NODES.indexOf(nodeName) > -1) {\n    if (!node.isAnyEventBinded()) {\n      data[Shortcuts.NodeName] = `static-${nodeName}`\n      if (nodeName === VIEW && !isHasExtractProp(node)) {\n        data[Shortcuts.NodeName] = PURE_VIEW\n      }\n    }\n\n    if (nodeName === VIEW && node.isOnlyClickBinded() && !isHasExtractProp(node)) {\n      data[Shortcuts.NodeName] = CLICK_VIEW\n    }\n  }\n\n  const { props } = node\n  for (const prop in props) {\n    const propInCamelCase = toCamelCase(prop)\n    if (\n      !prop.startsWith('data-') && // 在 node.dataset 的数据\n      prop !== CLASS &&\n      prop !== STYLE &&\n      prop !== ID &&\n      propInCamelCase !== CATCHMOVE &&\n      propInCamelCase !== COMPILE_MODE\n    ) {\n      data[propInCamelCase] = props[prop]\n    }\n    if (\n      process.env.TARO_ENV !== 'swan' &&\n      nodeName === VIEW &&\n      propInCamelCase === CATCHMOVE &&\n      props[prop] !== false\n    ) {\n      data[Shortcuts.NodeName] = CATCH_VIEW\n    }\n    if (propInCamelCase === COMPILE_MODE) {\n      compileModeName = props[prop]\n    }\n  }\n\n  // Children\n  data[Shortcuts.Childnodes] = node.childNodes.filter(node => !isComment(node)).map(hydrate)\n\n  if (node.className !== '') {\n    data[Shortcuts.Class] = node.className\n  }\n\n  const cssText = node.cssText\n  if (cssText !== '' && nodeName !== 'swiper-item') {\n    data[Shortcuts.Style] = cssText\n  }\n\n  hooks.call('modifyHydrateData', data, node)\n\n  const nn = data[Shortcuts.NodeName]\n  const componentAlias = componentsAlias[nn]\n  if (componentAlias) {\n    data[Shortcuts.NodeName] = componentAlias._num\n    for (const prop in data) {\n      if (prop in componentAlias) {\n        data[componentAlias[prop]] = data[prop]\n        delete data[prop]\n      }\n    }\n  }\n\n  if (compileModeName !== null) {\n    data[Shortcuts.NodeName] = compileModeName\n  }\n\n  const resData = hooks.call('transferHydrateData', data, node, componentAlias)\n\n  return resData || data\n}\n"],"mappings":";;;;;;;AAmBA,IAAI;AACJ,IAAI;;;;;;;AAQJ,SAAgB,QAASA,MAAwC;AAE/D,qBAAoB,oBAAoB;AAGxC,mBAAkB,iBAAM,KAAK,kBAAkB;CAE/C,MAAM,WAAW,KAAK;CACtB,IAAI,kBAAkB;AAEtB,KAAI,OAAO,KAAK,EAAE;AAChB,SAAO;GACL,KAAK,KAAK;IACTC,iBAAU,OAAO,KAAK;IACtBA,iBAAU,WAAW,gBAAgB,WAAW,QAAQ;EAC1D;CACF;CAED,MAAMC,OAAwB;GAC3BD,iBAAU,WAAW;EACtB,KAAK,KAAK;CACX;AAED,KAAI,KAAK,QAAQ,KAAK,KAAK;AACzB,OAAK,MAAM,KAAK;CACjB;AAED,KAAI,cAAc,QAAQ,SAAS,IAAI,GAAG;AACxC,OAAK,KAAK,kBAAkB,EAAE;AAC5B,QAAKA,iBAAU,aAAa,SAAS,SAAS;AAC9C,OAAI,aAAa,SAAS,iBAAiB,KAAK,EAAE;AAChD,SAAKA,iBAAU,YAAY;GAC5B;EACF;AAED,MAAI,aAAa,QAAQ,KAAK,mBAAmB,KAAK,iBAAiB,KAAK,EAAE;AAC5E,QAAKA,iBAAU,YAAY;EAC5B;CACF;CAED,MAAM,EAAE,OAAO,GAAG;AAClB,MAAK,MAAM,QAAQ,OAAO;EACxB,MAAM,kBAAkB,kCAAY,KAAK;AACzC,OACG,KAAK,WAAW,QAAQ,IACzB,SAAS,SACT,SAAS,SACT,SAAS,MACT,oBAAoB,aACpB,oBAAoB,cACpB;AACA,QAAK,mBAAmB,MAAM;EAC/B;AACD,MACE,QAAQ,IAAI,aAAa,UACzB,aAAa,QACb,oBAAoB,aACpB,MAAM,UAAU,OAChB;AACA,QAAKA,iBAAU,YAAY;EAC5B;AACD,MAAI,oBAAoB,cAAc;AACpC,qBAAkB,MAAM;EACzB;CACF;AAGD,MAAKA,iBAAU,cAAc,KAAK,WAAW,OAAO,aAAS,UAAUE,OAAK,CAAC,CAAC,IAAI,QAAQ;AAE1F,KAAI,KAAK,cAAc,IAAI;AACzB,OAAKF,iBAAU,SAAS,KAAK;CAC9B;CAED,MAAM,UAAU,KAAK;AACrB,KAAI,YAAY,MAAM,aAAa,eAAe;AAChD,OAAKA,iBAAU,SAAS;CACzB;AAED,kBAAM,KAAK,qBAAqB,MAAM,KAAK;CAE3C,MAAM,KAAK,KAAKA,iBAAU;CAC1B,MAAM,iBAAiB,gBAAgB;AACvC,KAAI,gBAAgB;AAClB,OAAKA,iBAAU,YAAY,eAAe;AAC1C,OAAK,MAAM,QAAQ,MAAM;AACvB,OAAI,QAAQ,gBAAgB;AAC1B,SAAK,eAAe,SAAS,KAAK;AAClC,WAAO,KAAK;GACb;EACF;CACF;AAED,KAAI,oBAAoB,MAAM;AAC5B,OAAKA,iBAAU,YAAY;CAC5B;CAED,MAAM,UAAU,iBAAM,KAAK,uBAAuB,MAAM,MAAM,eAAe;AAE7E,QAAO,WAAW;AACnB"}